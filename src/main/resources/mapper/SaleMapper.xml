<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="team.cheese.dao.SaleMapper">
    <sql id="selectFromSale">
        SELECT no, addr_cd, addr_name, seller_id, seller_nick, sal_i_cd, sal_name, pro_s_cd, tx_s_cd, trade_s_cd_1, trade_s_cd_2, sal_s_cd, title, contents, price, bid_cd, pickup_addr_cd, pickup_addr_name, detail_addr, brand, reg_price, buyer_id, buyer_nick, like_cnt, view_cnt, r_date, m_date, hoist_cnt, h_date, bid_cnt, ur_state, ad_state
        FROM sale
    </sql>

    <select id="count" resultType="int">
        SELECT count(*)
        FROM sale
    </select>

    <select id="countUse" resultType="int">
        SELECT count(*)
        FROM sale
        WHERE ur_state = 'Y'
    </select>

    <!-- CRUD  -->
    <!--  R : 전체 게시글 선택  -->
    <select id="selectAll" resultType="SaleDto">
        <include refid="selectFromSale"/>
        where 1=1
        and ur_state = 'Y'
        ORDER BY no DESC
    </select>

    <!--   R : 게시글 하나 선택    -->
    <!--  no를 변경해 줘야 됨  -->
    <select id="select" resultType="SaleDto">
        <include refid="selectFromSale"/>
        where 1=1
        and no = #{no}
        and ur_state = 'Y'
    </select>

    <!-- C : 판매글 작성 : 사용자 입력값 삽입하기 -->
    <insert id="insert" parameterType="SaleDto" useGeneratedKeys="true" keyProperty="no">
        INSERT INTO sale (addr_cd, addr_name, seller_id, seller_nick, sal_i_cd, sal_name, pro_s_cd, tx_s_cd,
                          trade_s_cd_1, trade_s_cd_2, price,
                          sal_s_cd, title, contents, bid_cd, pickup_addr_cd, pickup_addr_name, detail_addr, brand,
                          reg_price)
        SELECT a.addr_cd,
               a.addr_name,
               #{seller_id},
               (SELECT nick FROM user WHERE id = #{seller_id}),
               #{sal_i_cd},
               (SELECT name FROM sale_category WHERE sal_cd = #{sal_i_cd}),
               #{pro_s_cd},
               #{tx_s_cd},
               #{trade_s_cd_1},
               #{trade_s_cd_2},
               #{price},
               #{sal_s_cd},
               #{title},
               #{contents},
               #{bid_cd},
               #{pickup_addr_cd},
               (select addr_name as pickup_addr_cd from administrative where addr_cd = #{pickup_addr_cd}),
               #{detail_addr},
               #{brand},
               #{reg_price}
        FROM addr_cd a
        WHERE a.ur_id = #{seller_id}
        LIMIT #{check_addr_cd}, 1
    </insert>

    <!-- U : 판매글 수정하는 경우  -->
    <update id="update" parameterType="SaleDto">
        UPDATE sale
        SET addr_cd          = #{addr_cd},                                                               -- 주소 코드
            addr_name        = #{addr_name},                                                             -- 주소 이름
            seller_id        = #{seller_id},                                                             -- 판매자 ID
            seller_nick      = (SELECT nick FROM user WHERE id = #{seller_id}),                          -- 판매자 닉네임
            sal_i_cd         = #{sal_i_cd},                                                              -- 판매 카테고리 코드
            sal_name         = (SELECT name FROM sale_category WHERE sal_cd = #{sal_i_cd}),                -- 판매 카테고리 이름
            pro_s_cd         = #{pro_s_cd},                                                              -- 상품 상태 코드
            tx_s_cd          = #{tx_s_cd},                                                               -- 거래 방식 코드
            trade_s_cd_1     = #{trade_s_cd_1},                                                          -- 거래 방법1 코드
            trade_s_cd_2     = #{trade_s_cd_2},                                                          -- 거래 방법2 코드
            price            = #{price},                                                                 -- 상품 가격
            sal_s_cd         = #{sal_s_cd},                                                              -- 판매 상태 코드
            title            = #{title},                                                                 -- 판매글 제목
            contents         = #{contents},                                                              -- 판매 상품 설명
            bid_cd           = #{bid_cd},                                                                -- 가격제시/나눔 여부
            pickup_addr_cd   = #{pickup_addr_cd},                                                        -- 거래희망장소 코드
            pickup_addr_name = (SELECT addr_name FROM administrative WHERE addr_cd = #{pickup_addr_cd}), -- 거래희망장소 주소명
            detail_addr      = #{detail_addr},                                                           -- 거래희망장소 상세장소(위치)
            brand            = #{brand},                                                                 -- 상품 브랜드
            reg_price        = #{reg_price},                                                             -- 상품 정가
            m_date           = NOW(),                                                                    -- 수정 날짜
            ur_state         = 'N'                                                                       -- 사용자 상태
        WHERE no = #{no} -- 판매글 번호
    </update>

    <!--  D : 판매글 작성자가 판매글 삭제하는 경우_데이터 보존을 위해서 삭제하지 않고 사용 여부만 변경해줌  -->
    <update id="delete" parameterType="SaleDto">
        UPDATE sale
        SET m_date   = now(),
            ur_state = 'N'
        WHERE 1 = 1
          AND no = #{no}
    </update>

    <!--  D : 관리자가 판매글에 관여하는 경우_데이터 보존을 위해서 삭제하지 않고 사용 여부만 변경해줌  -->
    <update id="adminState" parameterType="SaleDto">
        UPDATE sale
        SET m_date = now(),
        <if test="ad_state == 'Y'">
            ad_state = 'N'
        </if>
        <if test="ad_state == 'N'">
            ad_state = 'Y'
        </if>
        WHERE 1 = 1
        AND no = #{no}
    </update>

</mapper>